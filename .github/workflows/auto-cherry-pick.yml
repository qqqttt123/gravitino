name: Automatically cherry-pick merged PR to different branches

on:
  push:
    branches:
      - main

jobs:
  detect-cherry-pick-labels:
    runs-on: ubuntu-latest
    name: Detect cherry-pick labels from merged PR
    outputs:
      branch-1-0: ${{ steps.check-labels.outputs.branch-1-0 }}
      branch-1-1: ${{ steps.check-labels.outputs.branch-1-1 }}
      branch-1-2: ${{ steps.check-labels.outputs.branch-1-2 }}
      pr-number: ${{ steps.get-pr.outputs.pr-number }}
      commit-sha: ${{ steps.get-pr.outputs.commit-sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR number from commit
        id: get-pr
        run: |
          # Get the commit message
          COMMIT_MESSAGE=$(git log -1 --pretty=%B ${{ github.sha }})
          echo "Commit message: $COMMIT_MESSAGE"
          
          # Extract PR number from merge commit message (format: "Merge pull request #1234")
          # or from squash commit message (format: "... (#1234)")
          PR_NUMBER=$(echo "$COMMIT_MESSAGE" | grep -oE '#[0-9]+' | head -1 | sed 's/#//')
          
          if [ -z "$PR_NUMBER" ]; then
            echo "No PR number found in commit message"
            echo "pr-number=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found PR number: $PR_NUMBER"
          echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "commit-sha=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Check PR labels
        id: check-labels
        if: steps.get-pr.outputs.pr-number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.get-pr.outputs.pr-number }}
          
          # Get PR labels using GitHub CLI
          LABELS=$(gh pr view $PR_NUMBER --json labels --jq '.labels[].name' || echo "")
          echo "PR #$PR_NUMBER labels: $LABELS"
          
          # Check for each branch label
          if echo "$LABELS" | grep -q "branch-1.0"; then
            echo "branch-1-0=true" >> $GITHUB_OUTPUT
          else
            echo "branch-1-0=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$LABELS" | grep -q "branch-1.1"; then
            echo "branch-1-1=true" >> $GITHUB_OUTPUT
          else
            echo "branch-1-1=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$LABELS" | grep -q "branch-1.2"; then
            echo "branch-1-2=true" >> $GITHUB_OUTPUT
          else
            echo "branch-1-2=false" >> $GITHUB_OUTPUT
          fi

  cherry-pick-branch-1-0:
    needs: detect-cherry-pick-labels
    if: needs.detect-cherry-pick-labels.outputs.branch-1-0 == 'true'
    uses: ./.github/workflows/cherry-pick-branch.yml
    with:
      target-branch: branch-1.0
      commit-sha: ${{ needs.detect-cherry-pick-labels.outputs.commit-sha }}
      pr-number: ${{ needs.detect-cherry-pick-labels.outputs.pr-number }}
    secrets: inherit

  cherry-pick-branch-1-1:
    needs: detect-cherry-pick-labels
    if: needs.detect-cherry-pick-labels.outputs.branch-1-1 == 'true'
    uses: ./.github/workflows/cherry-pick-branch.yml
    with:
      target-branch: branch-1.1
      commit-sha: ${{ needs.detect-cherry-pick-labels.outputs.commit-sha }}
      pr-number: ${{ needs.detect-cherry-pick-labels.outputs.pr-number }}
    secrets: inherit

  cherry-pick-branch-1-2:
    needs: detect-cherry-pick-labels
    if: needs.detect-cherry-pick-labels.outputs.branch-1-2 == 'true'
    uses: ./.github/workflows/cherry-pick-branch.yml
    with:
      target-branch: branch-1.2
      commit-sha: ${{ needs.detect-cherry-pick-labels.outputs.commit-sha }}
      pr-number: ${{ needs.detect-cherry-pick-labels.outputs.pr-number }}
    secrets: inherit
